flowchart TB
  %% Switch detailed architecture + message flow

  %% =====================
  %% XMPP edge
  %% =====================
  User["User XMPP Client"]
  XMPP["ejabberd (XMPP)"]

  User <--> XMPP

  %% =====================
  %% Orchestration plane
  %% =====================
  Dispatcher["DispatcherBot\nsrc/bots/dispatcher.py"]
  Manager["SessionManager\nsrc/manager.py"]
  Lifecycle["lifecycle/sessions.py\nsrc/lifecycle/sessions.py"]

  DB["sessions.db (SQLite)\nrepos: src/db.py\n- SessionRepository\n- MessageRepository\n- RalphLoopRepository"]

  XMPP -->|"message to orchestrator JID"| Dispatcher
  Dispatcher -->|create/kill| Manager
  Manager --> Lifecycle
  Lifecycle -->|create/close rows| DB

  %% =====================
  %% Per-session bot
  %% =====================
  SessionBot["SessionBot\nsrc/bots/session/bot.py"]
  Inbound["Inbound parsing\nsrc/bots/session/inbound.py"]
  Typing["TypingIndicator\nsrc/bots/session/typing.py"]
  Actor["[Q] SessionActor (queue + serialize)\nsrc/bots/session/actor.py"]

  XMPP -->|"message to session JID"| SessionBot
  SessionBot --> Inbound
  SessionBot --> Typing
  SessionBot --> Actor
  SessionBot -->|"persist chat"| DB

  %% =====================
  %% Attachments
  %% =====================
  AttStore["AttachmentStore\nsrc/attachments/store.py"]
  AttServer["Attachments HTTP server\nsrc/attachments/server.py"]

  SessionBot -->|"download image URLs"| AttStore
  AttStore -->|"build public_url"| AttServer

  %% =====================
  %% Runners boundary
  %% =====================
  Registry["runners registry\nsrc/runners/registry.py\ncreate_runner(engine, ...)" ]
  Ports["Runner port\nsrc/runners/ports.py\nrun() -> events\ncancel()" ]

  Actor -->|dequeue 1 at a time| Registry
  Registry --> Ports

  %% =====================
  %% Claude runner path (local)
  %% =====================
  ClaudeRunner["ClaudeRunner\nsrc/runners/claude/runner.py\n(SubprocessTransport -> claude CLI)"]
  LocalTools["Local tools\n(bash/read/write/edit/glob/grep/webfetch)"]

  Ports -->|engine=claude| ClaudeRunner
  ClaudeRunner -->|tool invocations| LocalTools
  ClaudeRunner -->|events: tool/text/result| SessionBot

  %% =====================
  %% OpenCode runner path (server)
  %% =====================
  OpenCodeRunner["OpenCodeRunner\nsrc/runners/opencode/runner.py"]
  OpenCodeConfig["OpenCodeConfig\nsrc/runners/opencode/config.py"]
  OpenCodeClient["OpenCodeClient\nsrc/runners/opencode/client.py"]
  OpenCodeTransport["OpenCodeTransport\nsrc/runners/opencode/transport.py"]
  OpenCodeProcessor["OpenCodeEventProcessor\nsrc/runners/opencode/processor.py"]
  Pipeline["iter_queue_pipeline()\nsrc/runners/pipeline.py\n(session gating + idle timeout)"]
  OpenCodeServer["External OpenCode server\n(HTTP + SSE; executes tools)"]

  Ports -->|engine=opencode| OpenCodeRunner
  OpenCodeRunner --> OpenCodeConfig
  OpenCodeRunner --> OpenCodeClient
  OpenCodeRunner --> OpenCodeTransport
  OpenCodeRunner --> OpenCodeProcessor
  OpenCodeRunner --> Pipeline
  OpenCodeClient <==>|"HTTP + SSE"| OpenCodeServer
  OpenCodeRunner -->|events: tool/text/question/result| SessionBot

  %% =====================
  %% Questions (OpenCode -> user -> OpenCode)
  %% =====================
  Question["Question meta\n(ask user; wait for reply)"]

  OpenCodeRunner -->|"event: question"| Question
  Question -->|"XMPP meta"| XMPP
  XMPP -->|"question-reply meta"| SessionBot
  SessionBot -->|"answer_question/reject"| OpenCodeClient

  %% =====================
  %% Cancellation paths
  %% =====================
  Cancel["[X] cancel_operations()\n(SessionBot)"]

  SessionBot -.-> Cancel
  Cancel -.->|"drop queued"| Actor
  Cancel -.->|"Runner.cancel()"| Ports
  Ports -.->|"/abort"| OpenCodeTransport

  classDef cancel stroke:#b00020,stroke-width:2px,fill:#fff5f6,color:#111;
  class Cancel,Actor cancel;
