flowchart TB
  %% Switch: big-block session architecture

  User["User XMPP Client"]
  XMPP["ejabberd (XMPP)"]
  Orchestrators["Orchestrators\n(DispatcherBot + SessionManager + lifecycle)"]

  Adapter["Session XMPP Adapter\n(SessionBot + parsing + typing + event sink)"]
  Core["[Q] Session Core\n(SessionRuntime)\n- queue + cancel\n- run (messages + Ralph)"]

  subgraph Runners["Runners"]
    direction TB
    Local["Local runner\n(ClaudeRunner + tools)"]
    Remote["Remote runner\n(OpenCodeRunner + OpenCode server)"]
  end

  Storage["Storage\n(sessions.db + attachments)"]

  %% High-level flows
  User <--> XMPP
  XMPP -->|"orchestrator messages"| Orchestrators
  Orchestrators --> Storage

  XMPP -->|"session message"| Adapter
  Adapter -->|enqueue| Core
  Core -->|persist state/messages| Storage

  Core -->|execute| Local
  Core -->|execute| Remote

  %% Outbound path
  Core -->|emit OutboundMessage/ProcessingChanged| Adapter
  Adapter -->|send XMPP| XMPP

  %% Cancellation (single choke point)
  Adapter -.->|cancel| Core

  classDef core stroke:#111,stroke-width:2px,fill:#f8f8f8,color:#111;
  class Core core;
